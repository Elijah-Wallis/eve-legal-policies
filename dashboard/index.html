<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eve Outbound Dialing - Live Dashboard</title>
  <style>
    :root {
      --bg: #071025;
      --panel: #111a32;
      --panel-soft: #0e1730;
      --border: #263b6e;
      --text: #ebf1ff;
      --muted: #9db0df;
      --ok: #1fc27b;
      --warn: #efb53f;
      --bad: #f06b6b;
      --idle: #7f8cb2;
      --accent: #5fa8ff;
      --mono: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(120% 120% at 0% 0%, #14234f 0%, transparent 55%),
        radial-gradient(120% 120% at 100% 0%, #0f2b61 0%, transparent 45%),
        var(--bg);
      color: var(--text);
    }
    .frame {
      max-width: 1100px;
      margin: 24px auto;
      padding: 18px;
      display: grid;
      gap: 14px;
    }
    .top {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    h1 {
      margin: 0;
      font-size: clamp(1.4rem, 2.8vw, 1.9rem);
    }
    .pulse {
      height: 10px;
      width: 10px;
      border-radius: 99px;
      background: var(--warn);
      display: inline-block;
      margin-right: 8px;
      animation: pulse 1.1s infinite;
    }
    .pulse.ok { background: var(--ok); animation: none; }
    .pulse.down { background: var(--bad); animation: none; }
    @keyframes pulse {
      0% { transform: scale(0.9); opacity: 0.8; }
      70% { transform: scale(1.2); opacity: 0.25; }
      100% { transform: scale(0.9); opacity: 0.9; }
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      background: linear-gradient(180deg, var(--panel-soft), var(--panel));
      box-shadow: 0 4px 22px rgba(0, 0, 0, 0.25);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .kpi {
      margin: 0;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 12px;
    }
    .kpi h3 {
      margin: 0 0 6px;
      font-size: 0.88rem;
      color: var(--muted);
      font-weight: 600;
    }
    .kpi .value {
      margin: 0;
      font-size: 1.45rem;
      font-weight: 700;
      font-family: var(--mono);
    }
    .timeline {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .step {
      flex: 1 1 180px;
      min-width: 150px;
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 12px;
      padding: 10px;
      background: rgba(255,255,255,0.03);
    }
    .step .label {
      color: var(--muted);
      font-size: 0.82rem;
      margin-bottom: 6px;
    }
    .step .status {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      font-weight: 700;
      font-size: 0.95rem;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 99px;
      display: inline-block;
    }
    .dot.ok { background: var(--ok); }
    .dot.warn { background: var(--warn); }
    .dot.idle { background: var(--idle); }
    .dot.bad { background: var(--bad); }
    .mono {
      font-family: var(--mono);
      font-size: 0.9rem;
    }
    .list {
      margin: 0;
      padding-left: 18px;
      line-height: 1.45;
    }
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .chip {
      display: inline-flex;
      margin: 4px 6px 0 0;
      padding: 5px 9px;
      border-radius: 99px;
      background: rgba(130, 160, 255, 0.16);
      border: 1px solid rgba(130, 160, 255, 0.4);
      font-size: 0.82rem;
      font-family: var(--mono);
    }
    .error {
      color: var(--bad);
      font-weight: 700;
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.93rem;
    }
    .table-wrap {
      overflow-x: auto;
    }
    th, td {
      border-bottom: 1px solid rgba(255,255,255,0.08);
      text-align: left;
      padding: 8px 6px;
    }
    th {
      color: var(--muted);
      font-weight: 600;
    }
    td { white-space: nowrap; }
    .business-link {
      color: var(--accent);
      text-decoration: none;
      font-weight: 700;
      cursor: pointer;
    }
    .business-link:hover {
      text-decoration: underline;
    }
    .transcript-cell {
      max-width: 390px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text);
      font-size: 0.85rem;
    }
    .hint {
      color: var(--muted);
      font-size: 0.9rem;
      margin: 0;
    }
    .call-id-badge {
      color: var(--muted);
      font-family: var(--mono);
      font-size: 0.8rem;
      display: block;
      margin-top: 4px;
    }
    .call-detail-modal {
      position: fixed;
      inset: 0;
      background: rgba(7, 16, 37, 0.88);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      padding: 16px;
    }
    .call-detail-modal.open {
      display: flex;
    }
    .call-detail-panel {
      width: min(980px, 100%);
      background: linear-gradient(180deg, var(--panel-soft), var(--panel));
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      max-height: 90vh;
      overflow: auto;
      box-shadow: 0 12px 38px rgba(0, 0, 0, 0.45);
    }
    .call-detail-head {
      display: flex;
      align-items: start;
      justify-content: space-between;
      gap: 10px;
    }
    .close-detail {
      border: 0;
      background: rgba(255,255,255,0.1);
      color: var(--text);
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 700;
    }
    .call-detail-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    .detail-card {
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      padding: 8px;
      background: rgba(255,255,255,0.03);
    }
    .detail-card h4 {
      margin: 0 0 6px;
      color: var(--muted);
      font-size: 0.84rem;
      font-weight: 600;
    }
    .detail-line {
      margin: 3px 0;
      font-family: var(--mono);
      font-size: 0.82rem;
    }
    .transcript-log {
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      padding: 8px;
      margin-top: 10px;
      background: rgba(255,255,255,0.03);
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 300px;
      overflow: auto;
      font-size: 0.84rem;
      line-height: 1.35;
    }
    .action-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn {
      border: 0;
      border-radius: 9px;
      padding: 8px 12px;
      background: linear-gradient(180deg, #2955cc, #153a9f);
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    @media (max-width: 780px) {
      .two-col { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="frame">
    <div class="top">
      <div>
        <h1>ðŸš€ Outbound Dialing Live Dashboard</h1>
        <p class="hint" id="campaign">Loading campaign...</p>
      </div>
      <div class="action-row">
        <button class="btn" id="startBtn">Open Campaign Start Command</button>
        <span id="ping" class="pulse"></span><span id="stateText" class="hint">Connecting...</span>
      </div>
    </div>

    <section class="card">
      <div class="timeline" id="timeline"></div>
    </section>

    <section class="grid">
      <div class="kpi">
        <h3>Leads in Queue</h3>
        <p class="value" id="kpiQueue">â€”</p>
      </div>
      <div class="kpi">
        <h3>Calls Attempted (Today)</h3>
        <p class="value" id="kpiDaily">â€”</p>
      </div>
      <div class="kpi">
        <h3>Call Artifacts</h3>
        <p class="value" id="kpiCalls">â€”</p>
      </div>
      <div class="kpi">
        <h3>Mapped Journeys</h3>
        <p class="value" id="kpiJourneys">â€”</p>
      </div>
      <div class="kpi">
        <h3>Pipeline State</h3>
        <p class="value" id="kpiPipeline">â€”</p>
      </div>
    </section>

    <section class="two-col">
      <article class="card">
        <h3>Conversion Breakdown</h3>
        <div id="conversion" class="hint">No data yet.</div>
      </article>
      <article class="card">
        <h3>Call Status</h3>
        <div id="callStatus" class="hint">No data yet.</div>
      </article>
    </section>

    <section class="card">
      <h3>Latest Calls</h3>
      <div id="latestError" class="error" style="display:none;"></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Business</th>
              <th>To</th>
              <th>Transcript</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="latestCalls">
            <tr><td colspan="4" class="hint">Waiting for calls...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h3>Segment Overview</h3>
      <div id="segments"></div>
    </section>

    <section class="card">
      <h3>Whatâ€™s happening under the hood</h3>
      <ul class="list">
        <li>1) Build live queue from leads (or Apify/local file).</li>
        <li>2) Dispatch calls with Retell + metadata for each lead.</li>
        <li>3) Map outcomes from transcripts into journey events.</li>
        <li>4) Feed n8n follow-up and nurture actions.</li>
        <li>5) Export outcomes to Supabase and Ops summaries.</li>
      </ul>
      <p class="hint">Tip: keep this running while dialing to confirm each step lights up green.</p>
    </section>
  </div>

  <div class="call-detail-modal" id="callDetailModal" aria-live="polite" role="dialog" aria-modal="true" aria-labelledby="callDetailTitle">
    <div class="call-detail-panel">
      <div class="call-detail-head">
        <div>
          <h2 id="callDetailTitle" style="margin:0 0 2px;font-size:1.1rem;">Call Detail</h2>
          <p id="callDetailSub" class="hint" style="margin:0;">Loading call artifact...</p>
        </div>
        <button class="close-detail" id="closeCallDetail">Close</button>
      </div>

      <div class="call-detail-meta">
        <article class="detail-card">
          <h4>Call Meta</h4>
          <div id="callMetaLine1" class="detail-line"></div>
          <div id="callMetaLine2" class="detail-line"></div>
          <div id="callMetaLine3" class="detail-line"></div>
        </article>
        <article class="detail-card">
          <h4>Tool Calls</h4>
          <div id="callTools" class="detail-line"></div>
        </article>
        <article class="detail-card">
          <h4>Outcome</h4>
          <div id="callOutcome" class="detail-line"></div>
          <div id="callRecordingLink" class="detail-line"></div>
        </article>
      </div>

      <div class="call-detail-card detail-card" style="margin-top: 10px;">
        <h4>Transcript</h4>
        <div id="callTranscript" class="transcript-log">No transcript loaded.</div>
      </div>
    </div>
  </div>

  <script>
    const stepLabels = [
      { key: "intake", label: "Lead Intake Ready" },
      { key: "dispatch", label: "Retell Dispatch Running" },
      { key: "mapping", label: "Journey Mapping" },
      { key: "persistence", label: "Supabase Dispatch" },
      { key: "nurture", label: "Nurture Signals" },
    ];

    const statusClassByState = {
      ok: "ok",
      running: "warn",
      idle: "idle",
      bad: "bad",
    };

    const state = {
      detailOpen: false,
    };

    function fmtInt(v) { return String(Number(v || 0)); }

    function escapeHtml(value) {
      const s = String(value == null ? "" : value);
      return s.replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
    }

    function closeCallDetail() {
      const modal = document.getElementById("callDetailModal");
      modal.classList.remove("open");
      state.detailOpen = false;
    }

    function msToSeconds(ms) {
      const v = Number(ms);
      if (!Number.isFinite(v)) return "â€”";
      return `${Math.round(v / 1000)}s`;
    }

    function formatCallTime(ts) {
      if (!ts) return "â€”";
      const d = new Date(typeof ts === "number" ? ts * 1000 : ts);
      if (Number.isNaN(d.getTime())) {
        return "â€”";
      }
      return d.toLocaleString();
    }

    function renderCallDetail(call) {
      const title = document.getElementById("callDetailTitle");
      const sub = document.getElementById("callDetailSub");
      const meta1 = document.getElementById("callMetaLine1");
      const meta2 = document.getElementById("callMetaLine2");
      const meta3 = document.getElementById("callMetaLine3");
      const tools = document.getElementById("callTools");
      const outcome = document.getElementById("callOutcome");
      const recording = document.getElementById("callRecordingLink");
      const transcript = document.getElementById("callTranscript");

      const business = call.clinic_name || call.call_id || "Unknown business";
      const callId = call.call_id || "â€”";
      const to = call.to_number || "â€”";
      const from = call.from_number || "â€”";
      const duration = msToSeconds(call.duration_ms);

      title.textContent = business;
      sub.textContent = `Call ID: ${callId}`;
      meta1.textContent = `To: ${to} Â· From: ${from}`;
      meta2.textContent = `Status: ${call.status || "unknown"}`;
      meta3.textContent = `Duration: ${duration}`;

      if (Array.isArray(call.tool_calls) && call.tool_calls.length) {
        tools.innerHTML = call.tool_calls
          .map((tool) => `<div>${escapeHtml(String(tool?.tool_name || tool?.name || JSON.stringify(tool)))}</div>`)
          .join("");
      } else {
        tools.innerHTML = "<span class=\"hint\">No tool calls.</span>";
      }

      const callSummary = call.call_analysis && call.call_analysis.call_summary ? call.call_analysis.call_summary : "â€”";
      const callSuccessful = call.call_analysis && call.call_analysis.call_successful === false
        ? "No"
        : (call.call_analysis && call.call_analysis.call_successful === true
            ? "Yes"
            : "â€”");
      outcome.innerHTML = `<div class=\"detail-line\">Summary: ${escapeHtml(callSummary)}</div>
                          <div class=\"detail-line\">Call successful: ${escapeHtml(callSuccessful)}</div>
                          <div class=\"detail-line\">Started: ${escapeHtml(formatCallTime(call.call_started_at))}</div>
                          <div class=\"detail-line\">Ended: ${escapeHtml(formatCallTime(call.call_ended_at))}</div>`;

      if (call.recording_url) {
        recording.innerHTML = `<a href=\"${escapeHtml(call.recording_url)}\" target=\"_blank\" rel=\"noreferrer\">Open recording</a>`;
      } else {
        recording.textContent = "No recording artifact yet.";
      }

      if (Array.isArray(call.transcript_lines) && call.transcript_lines.length) {
        transcript.innerHTML = call.transcript_lines
          .map((line) => `<div class=\"detail-line\">${escapeHtml(line)}</div>`)
          .join("");
      } else if (call.transcript) {
        transcript.textContent = call.transcript;
      } else {
        transcript.textContent = "No transcript available.";
      }
    }

    async function openCallDetail(callId) {
      if (!callId) return;
      try {
        const res = await fetch(`/api/dashboard/call-detail?call_id=${encodeURIComponent(callId)}`, { cache: "no-store" });
        if (!res.ok) {
          throw new Error("Could not load call details.");
        }
        const payload = await res.json();
        if (!payload.ok || !payload.call) {
          throw new Error("Call record not found.");
        }
        renderCallDetail(payload.call);
        const modal = document.getElementById("callDetailModal");
        modal.classList.add("open");
        state.detailOpen = true;
      } catch (err) {
        console.error(err);
      }
    }

    function stateDot(state) {
      return `<span class="dot ${statusClassByState[state] || "idle"}"></span>${state}`;
    }

    function chip(k, v) {
      return `<span class=\"chip\">${k}: ${v}</span>`;
    }

    async function fetchStatus() {
      try {
        const [statusRes, summaryRes] = await Promise.all([
          fetch("/api/dashboard/outbound", { cache: "no-store" }),
          fetch("/api/dashboard/summary", { cache: "no-store" }),
        ]);
        const status = await statusRes.json();
        const summary = await summaryRes.json();

        document.getElementById("campaign").textContent =
          `Campaign: ${status.campaign_id || "unknown"} â€¢ Tenant: ${status.tenant || "unknown"}`;

        const ping = document.getElementById("ping");
        const pingText = document.getElementById("stateText");
        if (summary && summary.status) {
          if (summary.status === "green") {
            ping.className = "pulse ok";
            pingText.textContent = "Dashboard API: healthy";
          } else if (summary.status === "red") {
            ping.className = "pulse bad";
            pingText.textContent = "Dashboard API: check alerts";
          } else {
            ping.className = "pulse";
            pingText.textContent = "Dashboard API: warning";
          }
        } else {
          ping.className = "pulse";
          pingText.textContent = "Fetchingâ€¦";
        }

        document.getElementById("kpiQueue").textContent = fmtInt(status.intake?.queue_size);
        document.getElementById("kpiDaily").textContent = `${fmtInt(status.dispatch?.daily_count)} / ${fmtInt(status.dispatch?.call_window_caps?.daily_call_cap)} today`;
        document.getElementById("kpiCalls").textContent = fmtInt(status.transcripts?.call_artifact_count);
        document.getElementById("kpiJourneys").textContent = fmtInt(status.journeys?.count);
        document.getElementById("kpiPipeline").textContent = status.pipeline_health?.stage || "idle";

        const timeline = document.getElementById("timeline");
        timeline.innerHTML = "";
        stepLabels.forEach((step) => {
          const s = status.step_status?.[step.key] || "idle";
          const node = document.createElement("div");
          node.className = "step";
          node.innerHTML = `<div class="label">${step.label}</div>
                           <div class="status">${stateDot(s)} <span>${step.key}</span></div>`;
          timeline.appendChild(node);
        });

        const conversion = document.getElementById("conversion");
        const conversionCounts = status.journeys?.conversion_counts || {};
        if (Object.keys(conversionCounts).length) {
          conversion.innerHTML = Object.entries(conversionCounts)
            .map(([k, v]) => chip(k, v))
            .join(" ");
        } else {
          conversion.textContent = "No mapped journeys yet.";
        }

        const callStatus = document.getElementById("callStatus");
        const statusCounts = status.transcripts?.call_status_counts || {};
        if (Object.keys(statusCounts).length) {
          callStatus.innerHTML = Object.entries(statusCounts)
            .map(([k, v]) => chip(k, v))
            .join(" ");
        } else {
          callStatus.textContent = "No call artifacts yet.";
        }

        const segments = document.getElementById("segments");
        const segmentMap = status.intake?.segments || {};
        segments.innerHTML = Object.keys(segmentMap).length
          ? Object.entries(segmentMap).map(([k, v]) => chip(k, v)).join(" ")
          : "<span class='hint'>No segment metadata yet.</span>";

        const latestCalls = document.getElementById("latestCalls");
        const calls = status.transcripts?.latest_calls || [];
        if (!calls.length) {
          latestCalls.innerHTML = "<tr><td colspan='4' class='hint'>Waiting for calls...</td></tr>";
        } else {
          latestCalls.innerHTML = calls.map((row) => {
            const callId = row.call_id || "-";
            const name = row.clinic_name || "Unknown business";
            const num = row.to_number || "-";
            const st = row.status || "-";
            const transcript = row.transcript_snippet || "";
            return `<tr>
              <td>
                <a href=\"#\" class=\"business-link\" data-call-id=\"${escapeHtml(callId)}\">${escapeHtml(name)}</a>
                ${callId !== "-" ? `<span class=\"call-id-badge\">Call ID: ${escapeHtml(callId)}</span>` : ""}
              </td>
              <td>${num}</td>
              <td class=\"transcript-cell\" title=\"${escapeHtml(transcript)}\">${escapeHtml(transcript) || "-"}</td>
              <td>${st}</td>
            </tr>`;
          }).join("");
        }

        const errEl = document.getElementById("latestError");
        if (status.intake?.queue_file && status.intake?.queue_file_exists !== false) {
          errEl.style.display = "none";
          if (!document.title.includes("Live")) {
            document.title = "Eve Outbound Dialing - Live Dashboard";
          }
          errEl.style.display = "none";
          errEl.textContent = "";
        } else {
          errEl.textContent = "Missing queue state files.";
          errEl.style.display = "block";
        }
      } catch (err) {
        const ping = document.getElementById("ping");
        const pingText = document.getElementById("stateText");
        ping.className = "pulse bad";
        pingText.textContent = "Dashboard API error";
        console.error(err);
      }
    }

    const btn = document.getElementById("startBtn");
    btn.addEventListener("click", async () => {
      const text = "make start";
      try {
        await navigator.clipboard.writeText(text);
        const old = btn.textContent;
        btn.textContent = "Copied: make start";
        setTimeout(() => (btn.textContent = old), 1600);
      } catch (_) {
        btn.textContent = "Run: make start";
      }
    });

    const latestCallsTable = document.getElementById("latestCalls");
    latestCallsTable.addEventListener("click", (event) => {
      const anchor = event.target.closest(".business-link");
      if (!anchor) {
        return;
      }
      event.preventDefault();
      const callId = anchor.dataset.callId;
      if (!callId || callId === "-") {
        return;
      }
      openCallDetail(callId);
    });

    const closeBtn = document.getElementById("closeCallDetail");
    const modal = document.getElementById("callDetailModal");
    closeBtn.addEventListener("click", closeCallDetail);
    modal.addEventListener("click", (event) => {
      if (event.target === modal) {
        closeCallDetail();
      }
    });
    window.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && state.detailOpen) {
        closeCallDetail();
      }
    });

    fetchStatus();
    setInterval(fetchStatus, 3000);
  </script>
</body>
</html>
